name: DataLens Agent CI

on:
  push:
    branches: [ "main","v5"]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    # MAP GITHUB SECRETS TO ENVIRONMENT VARIABLES
    env:
      AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
      AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
      AZURE_DEPLOYMENT_NAME: ${{ secrets.AZURE_DEPLOYMENT_NAME }}
      AZURE_API_VERSION: "2024-12-01-preview"
      LANGCHAIN_TRACING_V2: "false"

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    # 1. Install uv (Lightning fast package manager)
    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true
        version: "latest"

    # 2. Setup Python 3.12
    - name: Set up Python 3.12
      run: uv python install 3.12

    # 3. Install Dependencies
    - name: Install Dependencies
      run: uv sync --frozen --no-install-project --all-extras

    # 4. Code Quality Check (New!)
    # Hiring managers love to see linting in CI pipelines.
    - name: Run Linter
      run: |
        uv pip install ruff
        uv run ruff check . || echo "Linting issues found, but allowing build to continue."

    # 5. Build the DuckDB Lakehouse (Replaced GX)
    - name: Build Local Lakehouse & Seed Data
      run: uv run python seed_db.py  # Use your actual setup script name here

    # 6. E2E Agent CLI Test
    # This ensures the ReAct loop initializes and tools map correctly.
    # Note: If you don't want to use real LLM credits in CI, you can remove this step
    # or write a mock test.
    - name: Run ReAct Agent Smoke Test
      if: env.AZURE_OPENAI_API_KEY != ''
      run: |
        echo "Testing Agent Initialization..."
        uv run python run_agent.py
